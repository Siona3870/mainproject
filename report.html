<!DOCTYPE html>
<html>
<head>
    <title>Report Incident</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
    <h1 id="categoryTitle">Report Incident</h1>

    <form id="incidentForm">
        <label for="description">Description:</label><br>
        <textarea id="description" rows="4" cols="50"></textarea><br><br>

        <label for="locationInput">Location (India):</label><br>
        <input type="text" id="locationInput" placeholder="Type city, e.g., Kochi" autocomplete="off">
        <div id="suggestions" style="border: 1px solid #ccc; display:none; max-height:150px; overflow-y:auto;"></div><br><br>

        <button type="submit">Submit</button>
    </form>

    <script>
        // --- Nominatim API integration ---
        const locationInput = document.getElementById('locationInput');
        const suggestionsDiv = document.getElementById('suggestions');
        let selectedLocation = null; // will store {name, lat, lon}

        locationInput.addEventListener('input', async () => {
            const query = locationInput.value.trim();
            if (!query) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", India")}&limit=5`);
            const data = await response.json();

            suggestionsDiv.innerHTML = '';
            data.forEach(item => {
                const div = document.createElement('div');
                div.textContent = item.display_name;
                div.style.padding = '5px';
                div.style.cursor = 'pointer';
                div.addEventListener('click', () => {
                    locationInput.value = item.display_name;
                    selectedLocation = { name: item.display_name, lat: item.lat, lon: item.lon };
                    suggestionsDiv.style.display = 'none';
                });
                suggestionsDiv.appendChild(div);
            });

            suggestionsDiv.style.display = data.length ? 'block' : 'none';
        });

        document.addEventListener('click', (e) => {
            if (e.target !== locationInput) suggestionsDiv.style.display = 'none';
        });

        // --- Blockchain integration ---
        const contractAddress = "YOUR_CONTRACT_ADDRESS"; // replace with your deployed contract address
        const contractABI = [ /* ABI from Remix/Truffle compile */ ];

        document.getElementById('incidentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedLocation) {
                alert("Please select a location from suggestions.");
                return;
            }

            const description = document.getElementById('description').value;
            if (!description) { alert("Please enter description"); return; }

            if (!window.ethereum) { alert("MetaMask not found"); return; }
            const web3 = new Web3(window.ethereum);
            await ethereum.request({ method: 'eth_requestAccounts' });
            const accounts = await web3.eth.getAccounts();
            const account = accounts[0];

            const contract = new web3.eth.Contract(contractABI, contractAddress);

            // Send transaction to store incident
            contract.methods.reportIncident(selectedLocation.name)
                .send({ from: account })
                .on('transactionHash', hash => {
                    console.log("Tx sent:", hash);
                })
                .on('receipt', receipt => {
                    console.log("Incident stored on blockchain:", receipt);
                    alert(`Incident reported!\nID: ${receipt.events.IncidentReported.returnValues.id}\nLocation: ${selectedLocation.name}\nLat: ${selectedLocation.lat}, Lon: ${selectedLocation.lon}`);
                    window.location.href = "user.html"; // back to user page
                })
                .on('error', err => {
                    console.error(err);
                    alert("Error reporting incident.");
                });
        });
    </script>
</body>
</html>
